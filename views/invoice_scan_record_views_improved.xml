<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ============================================================ -->
        <!-- TREE VIEW - Am√©lior√©e avec indicateurs visuels -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_tree" model="ir.ui.view">
            <field name="name">invoice.scan.record.tree</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <tree string="Scans de factures" 
                      decoration-success="state=='done'" 
                      decoration-danger="state=='error'" 
                      decoration-warning="state=='duplicate'"
                      decoration-muted="state=='cancelled'"
                      decoration-info="state=='processing'"
                      multi_edit="1"
                      sample="1"
                      default_order="scan_date desc">
                    <header>
                        <button name="action_cancel" type="object" string="Annuler"/>
                    </header>
                    <field name="reference" readonly="1"/>
                    <field name="scan_date" widget="datetime"/>
                    <field name="supplier_name"/>
                    <field name="supplier_code_dgi" optional="hide"/>
                    <field name="invoice_number_dgi"/>
                    <field name="invoice_date" widget="date"/>
                    <field name="amount_ttc" sum="Total TTC" widget="monetary"/>
                    <field name="currency_id" column_invisible="1"/>
                    <field name="state" widget="badge" 
                           decoration-success="state == 'done'"
                           decoration-danger="state == 'error'"
                           decoration-warning="state == 'duplicate'"
                           decoration-info="state in ('draft', 'processing')"
                           decoration-muted="state == 'cancelled'"/>
                    <field name="invoice_id" optional="show"/>
                    <field name="invoice_state" widget="badge" optional="hide"
                           decoration-success="invoice_state == 'posted'"
                           decoration-info="invoice_state == 'draft'"
                           decoration-muted="invoice_state == 'cancel'"/>
                    <field name="scanned_by" widget="many2one_avatar_user"/>
                    <field name="duplicate_count" string="Doublons" optional="show"
                           decoration-warning="duplicate_count > 0"/>
                    <field name="retry_count" optional="hide"/>
                    <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                    <button name="action_view_invoice" type="object" 
                            string="Voir facture" icon="fa-file-text-o"
                            invisible="not invoice_id"/>
                    <button name="action_retry_create_invoice" type="object" 
                            string="R√©essayer" icon="fa-refresh"
                            class="text-warning"
                            invisible="state != 'error' or invoice_id"/>
                </tree>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- FORM VIEW - Design moderne et ergonomique -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_form" model="ir.ui.view">
            <field name="name">invoice.scan.record.form</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <form string="Scan de facture QR">
                    <header>
                        <button name="action_retry_create_invoice" string="üîÑ R√©essayer cr√©ation facture"
                                type="object" class="btn-primary"
                                invisible="state != 'error' or invoice_id"
                                confirm="Voulez-vous relancer la cr√©ation de la facture ?"/>
                        <button name="action_view_invoice" string="üìÑ Voir la facture"
                                type="object" class="btn-success"
                                invisible="not invoice_id"/>
                        <button name="action_cancel" string="Annuler" type="object" 
                                class="btn-secondary"
                                invisible="state in ('done', 'cancelled')"
                                confirm="Voulez-vous vraiment annuler ce scan ?"/>
                        <button name="action_set_to_draft" string="‚Ü©Ô∏è Remettre en brouillon" 
                                type="object" class="btn-secondary"
                                invisible="state not in ('error', 'cancelled')"/>
                        <field name="state" widget="statusbar" 
                               statusbar_visible="draft,processing,done"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_invoice" type="object" class="oe_stat_button"
                                    icon="fa-file-text-o" invisible="not invoice_id">
                                <div class="o_stat_info">
                                    <field name="invoice_id" readonly="1" nolabel="1" 
                                           widget="statinfo" string="Facture"/>
                                </div>
                            </button>
                            <button class="oe_stat_button" icon="fa-history"
                                    name="%(action_invoice_scan_record)d" type="action"
                                    context="{'search_default_scanned_by': scanned_by}">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">Autres scans</span>
                                </div>
                            </button>
                        </div>
                        
                        <!-- Alerte visuelle pour les erreurs -->
                        <div class="alert alert-danger" role="alert" invisible="state != 'error'">
                            <strong>‚ö†Ô∏è Erreur:</strong> <field name="error_message" nolabel="1" readonly="1"/>
                            <br/>
                            <small class="text-muted">Code: <field name="error_code" nolabel="1" readonly="1"/></small>
                        </div>
                        
                        <!-- Alerte pour les doublons -->
                        <div class="alert alert-warning" role="alert" invisible="duplicate_count == 0">
                            <strong>‚ö†Ô∏è Tentatives de doublons:</strong> 
                            Ce QR-code a √©t√© re-scann√© <field name="duplicate_count" nolabel="1" readonly="1" class="fw-bold"/> fois.
                            <br t-if="last_duplicate_attempt"/>
                            <small class="text-muted" invisible="not last_duplicate_attempt">
                                Derni√®re tentative: <field name="last_duplicate_attempt" nolabel="1" readonly="1" widget="datetime"/>
                                par <field name="last_duplicate_user_id" nolabel="1" readonly="1" widget="many2one_avatar_user"/>
                            </small>
                        </div>
                        
                        <!-- Titre avec r√©f√©rence -->
                        <div class="oe_title">
                            <label for="reference"/>
                            <h1>
                                <field name="reference" readonly="1" class="text-primary"/>
                            </h1>
                        </div>
                        
                        <group>
                            <group string="üì± Informations du scan">
                                <field name="qr_uuid" readonly="1" widget="char" 
                                       class="text-monospace"/>
                                <field name="qr_url" readonly="1" widget="url"/>
                                <field name="scan_date" readonly="1" widget="datetime"/>
                                <field name="scanned_by" readonly="1" 
                                       widget="many2one_avatar_user"/>
                                <field name="is_recent" invisible="1"/>
                                <field name="days_since_scan" readonly="1" 
                                       invisible="days_since_scan == 0"/>
                            </group>
                            <group string="üè¢ Donn√©es fournisseur (DGI)">
                                <field name="supplier_name" readonly="1"/>
                                <field name="supplier_code_dgi" readonly="1" 
                                       class="text-monospace"/>
                                <field name="customer_name" readonly="1"/>
                                <field name="customer_code_dgi" readonly="1"/>
                            </group>
                        </group>
                        
                        <group>
                            <group string="üí∞ Facture">
                                <field name="invoice_number_dgi" readonly="1"/>
                                <field name="invoice_date" readonly="1" widget="date"/>
                                <field name="verification_id" readonly="1" 
                                       class="text-monospace"/>
                                <label for="amount_ttc"/>
                                <div class="o_row">
                                    <field name="amount_ttc" readonly="1" 
                                           class="oe_inline fw-bold text-success"/>
                                    <field name="currency_id" readonly="1" 
                                           class="oe_inline" options="{'no_open': True}"/>
                                </div>
                                <field name="amount_ht" readonly="1" 
                                       invisible="not amount_ht"/>
                                <field name="amount_tva" readonly="1" 
                                       invisible="not amount_tva"/>
                            </group>
                            <group string="üìã R√©sultat Odoo">
                                <field name="partner_id" readonly="1"
                                       context="{'show_address': 1}"
                                       options="{'no_create': True}"/>
                                <field name="invoice_id" readonly="1"
                                       options="{'no_create': True}"/>
                                <field name="invoice_state" readonly="1" widget="badge"
                                       invisible="not invoice_id"
                                       decoration-success="invoice_state == 'posted'"
                                       decoration-info="invoice_state == 'draft'"/>
                                <field name="company_id" groups="base.group_multi_company" 
                                       readonly="1"/>
                            </group>
                        </group>
                        
                        <group string="‚öôÔ∏è Informations techniques" 
                               invisible="state != 'error'" 
                               groups="base.group_no_one">
                            <group>
                                <field name="retry_count" readonly="1"/>
                                <field name="max_retry" readonly="1"/>
                                <field name="can_retry" readonly="1"/>
                            </group>
                            <group>
                                <field name="processing_date" readonly="1"/>
                                <field name="processing_duration" readonly="1" 
                                       widget="float_time"/>
                            </group>
                        </group>
                        
                        <notebook groups="base.group_no_one">
                            <page string="üîç Donn√©es brutes DGI" name="raw_data">
                                <group>
                                    <field name="text_content" readonly="1" 
                                           widget="text" nolabel="1"/>
                                </group>
                                <group string="HTML brut">
                                    <field name="raw_html" readonly="1" 
                                           widget="text" nolabel="1"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids"/>
                        <field name="activity_ids"/>
                        <field name="message_ids"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- SEARCH VIEW - Filtres et groupements am√©lior√©s -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_search" model="ir.ui.view">
            <field name="name">invoice.scan.record.search</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <search string="Rechercher un scan">
                    <!-- Champs de recherche -->
                    <field name="reference"/>
                    <field name="supplier_name" filter_domain="[('supplier_name', 'ilike', self)]"/>
                    <field name="supplier_code_dgi"/>
                    <field name="invoice_number_dgi"/>
                    <field name="qr_uuid"/>
                    <field name="scanned_by"/>
                    <field name="partner_id"/>
                    <field name="invoice_id"/>
                    
                    <separator/>
                    
                    <!-- Filtres par √©tat -->
                    <filter string="‚úÖ Factures cr√©√©es" name="filter_done" 
                            domain="[('state', '=', 'done')]" 
                            icon="fa-check-circle"/>
                    <filter string="‚è≥ En traitement" name="filter_processing" 
                            domain="[('state', '=', 'processing')]"/>
                    <filter string="‚ùå Erreurs" name="filter_error" 
                            domain="[('state', '=', 'error')]" 
                            icon="fa-exclamation-triangle"/>
                    <filter string="‚ö†Ô∏è Doublons" name="filter_duplicate" 
                            domain="[('state', '=', 'duplicate')]" 
                            icon="fa-copy"/>
                    <filter string="üö´ Annul√©s" name="filter_cancelled" 
                            domain="[('state', '=', 'cancelled')]"/>
                    
                    <separator/>
                    
                    <!-- Filtres temporels -->
                    <filter string="üìÖ Aujourd'hui" name="filter_today" 
                            domain="[('scan_date', '&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0)))]"/>
                    <filter string="üìÖ Cette semaine" name="filter_week"
                            domain="[('scan_date', '&gt;=', (context_today() - datetime.timedelta(days=7)))]"/>
                    <filter string="üìÖ Ce mois" name="filter_month"
                            domain="[('scan_date', '&gt;=', datetime.datetime(context_today().year, context_today().month, 1))]"/>
                    <filter string="üìÖ Cette ann√©e" name="filter_year"
                            domain="[('scan_date', '&gt;=', datetime.datetime(context_today().year, 1, 1))]"/>
                    
                    <separator/>
                    
                    <!-- Filtres utilisateur -->
                    <filter string="üë§ Mes scans" name="filter_mine" 
                            domain="[('scanned_by', '=', uid)]"/>
                    <filter string="üîÑ Peut r√©essayer" name="filter_can_retry"
                            domain="[('state', '=', 'error'), ('invoice_id', '=', False), ('retry_count', '&lt;', 3)]"/>
                    <filter string="üí∞ Gros montants (>1M)" name="filter_high_amount"
                            domain="[('amount_ttc', '&gt;=', 1000000)]"/>
                    
                    <separator/>
                    
                    <!-- Groupements -->
                    <group expand="0" string="Regrouper par">
                        <filter string="√âtat" name="group_state" 
                                context="{'group_by': 'state'}"/>
                        <filter string="Fournisseur" name="group_supplier" 
                                context="{'group_by': 'supplier_name'}"/>
                        <filter string="Date du scan" name="group_date" 
                                context="{'group_by': 'scan_date:day'}"/>
                        <filter string="Mois du scan" name="group_month" 
                                context="{'group_by': 'scan_date:month'}"/>
                        <filter string="Scann√© par" name="group_user" 
                                context="{'group_by': 'scanned_by'}"/>
                        <filter string="Soci√©t√©" name="group_company" 
                                context="{'group_by': 'company_id'}"
                                groups="base.group_multi_company"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- KANBAN VIEW - Vue moderne et informative -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_kanban" model="ir.ui.view">
            <field name="name">invoice.scan.record.kanban</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" sample="1" 
                        default_group_by="state" quick_create="0">
                    <field name="id"/>
                    <field name="reference"/>
                    <field name="supplier_name"/>
                    <field name="invoice_number_dgi"/>
                    <field name="amount_ttc"/>
                    <field name="currency_id"/>
                    <field name="state"/>
                    <field name="scan_date"/>
                    <field name="scanned_by"/>
                    <field name="invoice_id"/>
                    <field name="is_recent"/>
                    <progressbar field="state" 
                                 colors='{"done": "success", "error": "danger", "duplicate": "warning", "draft": "info", "processing": "primary", "cancelled": "muted"}'/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click #{record.is_recent.raw_value ? 'border-start border-4 border-info' : ''}">
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top mb-2">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="reference"/>
                                            </strong>
                                            <t t-if="record.is_recent.raw_value">
                                                <span class="badge bg-info ms-1" title="Scan r√©cent">
                                                    <i class="fa fa-clock-o"/>
                                                </span>
                                            </t>
                                        </div>
                                        <field name="state" widget="label_selection" 
                                               options="{'classes': {'draft': 'secondary', 'processing': 'primary', 'done': 'success', 'error': 'danger', 'duplicate': 'warning', 'cancelled': 'dark'}}"/>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div class="mb-1">
                                            <strong>
                                                <i class="fa fa-building-o me-1 text-muted"/>
                                                <field name="supplier_name" placeholder="Fournisseur inconnu"/>
                                            </strong>
                                        </div>
                                        <div class="text-muted small" t-if="record.invoice_number_dgi.raw_value">
                                            <i class="fa fa-file-text-o me-1"/>
                                            N¬∞ <field name="invoice_number_dgi"/>
                                        </div>
                                        <div class="mt-2">
                                            <span class="fw-bold text-success fs-6">
                                                <field name="amount_ttc" widget="monetary"/>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_bottom mt-2 pt-2 border-top">
                                        <div class="oe_kanban_bottom_left text-muted small">
                                            <i class="fa fa-calendar me-1"/>
                                            <field name="scan_date" widget="date"/>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <field name="scanned_by" widget="many2one_avatar_user"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- PIVOT VIEW - Analyse des donn√©es -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_pivot" model="ir.ui.view">
            <field name="name">invoice.scan.record.pivot</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <pivot string="Analyse des scans" sample="1">
                    <field name="scan_date" type="row" interval="month"/>
                    <field name="state" type="col"/>
                    <field name="amount_ttc" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- GRAPH VIEW - Graphiques -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_graph" model="ir.ui.view">
            <field name="name">invoice.scan.record.graph</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <graph string="√âvolution des scans" type="line" sample="1">
                    <field name="scan_date" interval="day"/>
                    <field name="amount_ttc" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- CALENDAR VIEW - Vue calendrier -->
        <!-- ============================================================ -->
        <record id="view_invoice_scan_record_calendar" model="ir.ui.view">
            <field name="name">invoice.scan.record.calendar</field>
            <field name="model">invoice.scan.record</field>
            <field name="arch" type="xml">
                <calendar string="Calendrier des scans" date_start="scan_date" 
                          color="state" mode="month" quick_add="0"
                          event_open_popup="1">
                    <field name="reference"/>
                    <field name="supplier_name"/>
                    <field name="amount_ttc"/>
                </calendar>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- ACTION PRINCIPALE -->
        <!-- ============================================================ -->
        <record id="action_invoice_scan_record" model="ir.actions.act_window">
            <field name="name">Scans de factures</field>
            <field name="res_model">invoice.scan.record</field>
            <field name="view_mode">tree,kanban,form,pivot,graph,calendar</field>
            <field name="search_view_id" ref="view_invoice_scan_record_search"/>
            <field name="context">{'search_default_filter_today': 0}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Aucun scan de facture pour le moment
                </p>
                <p class="text-muted">
                    Utilisez l'<strong>application mobile</strong> pour scanner des QR-codes de factures DGI
                    et cr√©er automatiquement les factures fournisseur.
                </p>
                <p class="mt-3">
                    <a href="https://www.services.fne.dgi.gouv.ci" target="_blank" class="btn btn-outline-primary">
                        <i class="fa fa-external-link me-1"/> Site DGI C√¥te d'Ivoire
                    </a>
                </p>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- ACTION - Scans en erreur -->
        <!-- ============================================================ -->
        <record id="action_invoice_scan_record_errors" model="ir.actions.act_window">
            <field name="name">Scans en erreur</field>
            <field name="res_model">invoice.scan.record</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('state', '=', 'error')]</field>
            <field name="context">{'search_default_filter_can_retry': 1}</field>
        </record>

        <!-- ============================================================ -->
        <!-- ACTION - Scans r√©ussis aujourd'hui -->
        <!-- ============================================================ -->
        <record id="action_invoice_scan_record_today_success" model="ir.actions.act_window">
            <field name="name">Scans r√©ussis aujourd'hui</field>
            <field name="res_model">invoice.scan.record</field>
            <field name="view_mode">tree,kanban,form</field>
            <field name="domain">[('state', '=', 'done')]</field>
            <field name="context">{'search_default_filter_today': 1}</field>
        </record>

    </data>
</odoo>
